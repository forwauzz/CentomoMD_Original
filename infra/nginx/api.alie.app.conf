# Version-controlled Nginx for api.alie.app (reference)
# NOTE: Cert paths are placeholders; do NOT deploy blindly.
#       This file documents the intended config so prod and repo stay in sync.

server {
  listen 443 ssl http2;
  server_name api.alie.app;

  # TLS placeholders (replace with your real paths on the EC2 box when deploying)
  ssl_certificate     /etc/letsencrypt/live/api.alie.app/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/api.alie.app/privkey.pem;

  # --- Security headers ---
  # Single-line CSP (HTTP/2 safe). Adjust connect-src if you add endpoints.
  # If you prefer to ship CSP via backend instead, comment this out before deploy.
  add_header Content-Security-Policy "default-src 'self'; connect-src 'self' https://api.alie.app wss://api.alie.app; img-src 'self' data: https:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; base-uri 'self'; font-src 'self' https: data:; form-action 'self'; frame-ancestors 'self'; object-src 'none'; script-src-attr 'none'; upgrade-insecure-requests" always;

  # Optional hardening (uncomment if desired)
  # add_header X-Content-Type-Options nosniff always;
  # add_header X-Frame-Options DENY always;
  # add_header Referrer-Policy no-referrer-when-downgrade always;

  # --- Health ---
  location /healthz {
    proxy_pass http://127.0.0.1:3001/healthz;
  }

  # --- REST API ---
  location /api/ {
    proxy_pass http://127.0.0.1:3001/api/;
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout  3600;
    proxy_send_timeout  3600;
  }

  # --- WebSocket ---
  # Public path: wss://api.alie.app/ws  â†’  backend: http://127.0.0.1:3001/ws/transcription
  location /ws {
    proxy_pass http://127.0.0.1:3001/ws/transcription;
    proxy_http_version 1.1;
    proxy_set_header Upgrade   $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout  3600;
    proxy_send_timeout  3600;
  }

  # (Optional) gzip/brotli if you serve static from here
  # gzip on;
  # gzip_types text/plain text/css application/json application/javascript application/rss+xml application/xml+rss text/javascript;
}
