# Cases System Audit Report

## Executive Summary

This comprehensive audit examines the current implementation of the cases system across the entire application stack - database, backend APIs, frontend components, and data flow. The system implements a CNESST (Commission des normes, de l'équité, de la santé et de la sécurité du travail) form case management system with dictation integration.

## Database Architecture

### Core Tables

#### 1. `cases` Table
```sql
CREATE TABLE cases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,                    -- References auth.users(id)
  clinic_id UUID,                          -- References clinics(id)
  draft JSONB NOT NULL DEFAULT '{}',       -- Main case data storage
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**Key Features:**
- **JSONB Storage**: All case data stored in `draft` field as structured JSON
- **User Association**: Direct link to authenticated users
- **Clinic Association**: Optional clinic assignment
- **Audit Trail**: Created/updated timestamps

#### 2. `case_sessions` Table (Linking Table)
```sql
CREATE TABLE case_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  case_id UUID NOT NULL REFERENCES cases(id) ON DELETE CASCADE,
  section_id VARCHAR(50) NOT NULL,         -- CNESST section identifier
  session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
  content TEXT,                            -- Raw transcript content
  formatted_content TEXT,                  -- AI-formatted content
  created_at TIMESTAMP DEFAULT NOW()
);
```

**Purpose**: Links dictation sessions to specific case sections

#### 3. `sessions` Table
```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,                   -- References auth.users(id)
  clinic_id UUID REFERENCES clinics(id),
  patient_id VARCHAR(255) NOT NULL,
  consent_verified BOOLEAN DEFAULT FALSE,
  status TEXT CHECK (status IN ('active', 'paused', 'completed', 'cancelled')),
  mode TEXT CHECK (mode IN ('word_for_word', 'smart_dictation', 'ambient')),
  current_section TEXT CHECK (current_section IN ('section_7', 'section_8', 'section_11')),
  started_at TIMESTAMP DEFAULT NOW(),
  ended_at TIMESTAMP,
  duration_seconds INTEGER,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**Purpose**: Manages dictation sessions and their metadata

### Data Structure in `draft` JSONB Field

The `cases.draft` field contains a complex nested structure:

```typescript
interface CaseDraft {
  caseId: string | null;
  patientInfo: {
    name: string;           // Auto-generated: "Case YYYY-MM-DD HH:MM"
    id: string;
    dob: string;
    gender: string;
    phone: string;
    email: string;
    address: string;
  };
  physicianInfo: {
    lastName: string;
    firstName: string;
    license: string;
    address: string;
    phone: string;
    email: string;
  };
  sections: {
    [sectionId: string]: {
      data: any;            // Section-specific form data
      status: 'draft' | 'in_progress' | 'completed';
      lastModified: string;
    };
  };
  metadata: {
    language: 'fr' | 'en';
    status: 'draft' | 'in_progress' | 'completed';
    totalSections: number;
    completedSections: number;
    autoGeneratedName: boolean;
    lastAccessedAt: string;
    createdAt: string;
    updatedAt: string;
  };
  ui: {
    activeSectionId: string;
    order: string[];
    autosave: Record<string, string>;
  };
  sessions: any[];          // Linked session references
}
```

## Backend API Implementation

### Case Controller (`backend/src/controllers/caseController.ts`)

#### 1. GET `/api/cases` - List User Cases
```typescript
// Features:
- Authentication required via middleware
- Retention filtering (default 30 days)
- Status filtering (draft/in_progress/completed)
- Pagination support (default limit 10)
- Ordered by updated_at DESC
```

**Query Parameters:**
- `limit`: Number of cases to return (default: 10)
- `days`: Retention period in days (default: 30)
- `status`: Filter by case status

#### 2. POST `/api/cases` - Create New Case
```typescript
// Process:
1. Generate auto case name: "Case YYYY-MM-DD HH:MM"
2. Get clinic template for Section C3 pre-filling
3. Create structured draft with default values
4. Insert case record
5. Update caseId in draft
6. Return complete case data
```

**Request Body:**
```typescript
{
  patientInfo?: any;
  sections?: any;
  metadata?: { language?: string };
  clinic_id?: string;
}
```

#### 3. GET `/api/cases/:id` - Get Specific Case
```typescript
// Features:
- User ownership verification
- Complete case data with draft
- Fallback stub behavior for development
```

#### 4. PUT `/api/cases/:id` - Update Case
```typescript
// Process:
1. Verify case ownership
2. Merge new data with existing draft
3. Update metadata timestamps
4. Return updated case
```

#### 5. DELETE `/api/cases/:id` - Delete Case
```typescript
// Features:
- User ownership verification
- Cascade deletion of related records
- Audit logging
```

#### 6. POST `/api/cases/:id/sections/:sectionId` - Update Section
```typescript
// Process:
1. Verify case ownership
2. Update specific section in draft
3. Update section status and timestamps
4. Update case metadata
```

#### 7. POST `/api/cases/:id/sessions` - Link Session to Case
```typescript
// Process:
1. Verify case and session existence
2. Create case_sessions link record
3. Store content and formatted content
```

### Case Routes (`backend/src/routes/cases.ts`)

#### 1. POST `/api/cases/:id/sections/:sectionId/commit` - Commit Session Data
```typescript
// Process:
1. Extract finalText and sessionId from request
2. Create case if doesn't exist
3. Update section data in case draft
4. Link session to case section
```

### Authentication & Middleware

**Authentication Flow:**
- Uses `authenticateUser` middleware
- Extracts user from JWT token
- Verifies user ownership for all case operations
- Profile synchronization via `ensureProfileSynced`

## Frontend Implementation

### Case Store (`frontend/src/stores/caseStore.ts`)

**State Management:**
```typescript
interface CaseState {
  currentCase: Case | null;
  schema: FormSchema | null;
  activeSectionId: string;
  isDirty: boolean;
  lastSaved: string;
  autosaveTimestamps: Record<string, string>;
  isLoading: boolean;
  isSaving: boolean;
}
```

**Key Methods:**
- `createNewCase()`: Creates case via API with auto-save
- `loadCase(caseId)`: Loads case from backend
- `updateCaseDraft()`: Updates local case state
- `commitSectionFromSession()`: Links dictation to case sections
- `getRecentCases()`: Fetches user's recent cases
- `deleteCase()`: Removes case and related data

### UI Components

#### 1. NewCaseWithClinicSelection (`frontend/src/components/case/NewCaseWithClinicSelection.tsx`)
```typescript
// Features:
- Clinic selection modal
- Case creation with clinic context
- Navigation to new case page
- Error handling and loading states
```

#### 2. RecentCasesCard (`frontend/src/components/dashboard/RecentCasesCard.tsx`)
```typescript
// Features:
- Displays recent cases with progress
- Search and filter functionality
- Status indicators (draft/in_progress/completed)
- Case navigation and deletion
- Mock data fallback for development
```

#### 3. TranscriptionInterface Integration
```typescript
// Save to Section Flow:
1. User completes dictation
2. Selects target section(s) via dropdown
3. Creates session record
4. Links session to case section
5. Commits content to case draft
6. Updates UI with success feedback
```

### Feature Flags

**Case Management Features:**
- `caseManagement`: Enables/disables case management UI
- Controls visibility of recent cases, case creation, etc.

## Data Flow Architecture

### 1. Case Creation Flow
```
User Action → Clinic Selection → API Call → Database Insert → UI Update → Navigation
```

### 2. Dictation to Case Flow
```
Dictation → Session Creation → Section Selection → Case Linking → Draft Update → UI Sync
```

### 3. Case Update Flow
```
User Edit → Local State Update → API Call → Database Update → UI Refresh
```

## Key Features & Capabilities

### 1. Auto-Generated Case Names
- Format: "Case YYYY-MM-DD HH:MM"
- French locale formatting
- Automatic timestamp-based naming

### 2. Clinic Template Integration
- Pre-fills Section C3 with clinic-specific text
- Default clinic fallback (CMNDI)
- Template-based content injection

### 3. Section Management
- CNESST form sections (7, 8, 11, etc.)
- Status tracking (draft/in_progress/completed)
- Progress calculation and display
- Last modified timestamps

### 4. Session Linking
- Dictation sessions linked to case sections
- Content and formatted content storage
- Cascade deletion on case removal
- Audit trail maintenance

### 5. Retention & Cleanup
- Configurable retention periods
- Automatic cleanup of expired cases
- User-specific case filtering

## Current Limitations & Technical Debt

### 1. Authentication Issues
- Some endpoints use mock authentication
- Inconsistent user verification
- TODO comments for proper auth implementation

### 2. Error Handling
- Fallback stub behavior in development
- Inconsistent error responses
- Limited error recovery mechanisms

### 3. Data Consistency
- JSONB structure not fully validated
- Potential data migration issues
- Legacy format compatibility concerns

### 4. Performance Considerations
- No pagination for large case lists
- JSONB queries may be slow
- No caching layer implemented

### 5. Testing Coverage
- Limited test coverage for case operations
- Mock data used in production components
- No integration tests for case flows

## Recommendations

### 1. Immediate Fixes
- Implement consistent authentication across all endpoints
- Add proper error handling and validation
- Remove stub/fallback behaviors

### 2. Data Layer Improvements
- Add JSONB schema validation
- Implement proper indexing for JSONB queries
- Add data migration scripts for legacy cases

### 3. Performance Optimizations
- Implement case list pagination
- Add caching layer for frequently accessed cases
- Optimize JSONB queries with proper indexes

### 4. Testing & Quality
- Add comprehensive test coverage
- Implement integration tests for case flows
- Add data validation and sanitization

### 5. User Experience
- Improve error messaging and recovery
- Add offline support for case editing
- Implement real-time collaboration features

## Conclusion

The cases system provides a solid foundation for CNESST form management with dictation integration. The JSONB-based storage allows for flexible form structures, while the session linking enables seamless integration between dictation and case management. However, there are several areas requiring attention, particularly around authentication consistency, error handling, and performance optimization.

The system is currently functional but would benefit from the recommended improvements to ensure production readiness and maintainability.




